import pandas as pd
import plotly.express as px
import os
import webbrowser

# --- CONFIGURA√á√ïES ---
FILE_NAME = 'Comparativo - Americanense.xlsx - Americanense.csv'
HTML_OUTPUT = 'comparativo_tributario.html'
# O √≠ndice da linha que cont√©m o cabe√ßalho "Simples Nacional Atual", "Valor_Imposto" etc.
# Pelo seu arquivo, parece ser a linha 7, que √© o √≠ndice 6.
HEADER_ROW_INDEX = 6
# --------------------

def formatar_br(valor, tipo='moeda'):
    """Formata n√∫meros para o padr√£o brasileiro (R$ e %)"""
    if pd.isna(valor):
        return ""
    if tipo == 'moeda':
        return f'R$ {valor:,.2f}'.replace(',', 'X').replace('.', ',').replace('X', '.')
    elif tipo == 'porcentagem':
        return f'{valor*100:.2f}%'.replace('.', ',')
    return str(valor)

def generate_tax_dashboard():
    # 1. Carregamento e Prepara√ß√£o dos Dados
    try:
        # Pula as linhas at√© o cabe√ßalho principal
        df_raw = pd.read_csv(
            FILE_NAME, 
            sep=',', 
            encoding='utf-8', 
            header=HEADER_ROW_INDEX, 
            skipinitialspace=True
        )
        
        # Seleciona as colunas da tabela de GR√ÅFICOS (colunas G, H, I, J do Excel, que no CSV s√£o sem nome)
        # Assumindo que a tabela de compara√ß√£o come√ßa na coluna de √≠ndice 6 e vai at√© 9
        df_comparativo = df_raw.iloc[0:4, 6:9].copy() 
        df_comparativo.columns = ['Regime', 'Valor_Imposto', 'Aliquota_Efetiva']
        
    except FileNotFoundError:
        print(f"ERRO: Arquivo '{FILE_NAME}' n√£o encontrado.")
        return
    except Exception as e:
        print(f"Erro ao processar o CSV. Verifique se o √≠ndice de coluna est√° correto. Erro: {e}")
        return

    # Limpeza e convers√£o de dados
    df_comparativo['Valor_Imposto'] = pd.to_numeric(df_comparativo['Valor_Imposto'], errors='coerce')
    df_comparativo['Aliquota_Efetiva'] = pd.to_numeric(df_comparativo['Aliquota_Efetiva'], errors='coerce')
    df_comparativo = df_comparativo.dropna(subset=['Valor_Imposto'])
    
    # Confirma√ß√£o de Leitura antes de plotar
    if df_comparativo.empty or df_comparativo['Valor_Imposto'].sum() == 0:
        print("\n=======================================================")
        print("‚ö†Ô∏è DADOS N√ÉO LIDOS CORRETAMENTE!")
        print(f"O arquivo {FILE_NAME} √© muito complexo.")
        print("Tente alterar a vari√°vel 'HEADER_ROW_INDEX' no c√≥digo.")
        print(f"Primeiras linhas lidas para debug:\n{df_raw.head(8)}")
        print("=======================================================")
        return
        
    # Restante da l√≥gica (Cria√ß√£o dos Gr√°ficos)
    menor_imposto = df_comparativo['Valor_Imposto'].min()
    df_comparativo['Destaque'] = df_comparativo['Valor_Imposto'].apply(lambda x: 'Menor Imposto' if x == menor_imposto else 'Outros Regimes')

    # ... (Cria√ß√£o dos gr√°ficos fig_valor e fig_aliquota √© a mesma)
    
    # Gr√°fico 1: Comparativo do Valor Total de Impostos
    fig_valor = px.bar(
        df_comparativo,
        x='Regime',
        y='Valor_Imposto',
        color='Destaque',
        color_discrete_map={'Menor Imposto': '#28a745', 'Outros Regimes': '#007bff'},
        title='Comparativo do Valor Total de Impostos (R$)',
        text=df_comparativo['Valor_Imposto'].apply(lambda x: formatar_br(x, 'moeda')),
        template='plotly_white'
    )
    fig_valor.update_traces(textposition='outside')
    fig_valor.update_layout(yaxis_title="Valor do Imposto (R$)", xaxis_title=None, showlegend=False)

    # Gr√°fico 2: Comparativo da Al√≠quota Efetiva
    fig_aliquota = px.bar(
        df_comparativo,
        x='Regime',
        y='Aliquota_Efetiva',
        color='Destaque',
        color_discrete_map={'Menor Imposto': '#28a745', 'Outros Regimes': '#007bff'},
        title='Comparativo da Al√≠quota Efetiva (%)',
        text=df_comparativo['Aliquota_Efetiva'].apply(lambda x: formatar_br(x, 'porcentagem')),
        template='plotly_white'
    )
    fig_aliquota.update_traces(textposition='outside')
    fig_aliquota.update_layout(yaxis_title="Al√≠quota Efetiva", xaxis_title=None, yaxis_tickformat=".2%", showlegend=False)


    # Gera√ß√£o do HTML (Conte√∫do omitido para brevidade, √© o mesmo)

    html_content = f"""
<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Comparativo Tribut√°rio - Americanense</title>
    <meta charset="utf-8">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {{ font-family: 'Arial', sans-serif; margin: 0; background-color: #f0f2f5; }}
        .header {{ background-color: #007bff; color: white; padding: 25px; text-align: center; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }}
        h1 {{ margin: 0; font-size: 2.2em; }}
        .container {{ display: flex; flex-wrap: wrap; justify-content: space-around; padding: 20px; max-width: 1300px; margin: 30px auto; }}
        .card {{ background-color: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: 15px; padding: 20px; flex: 1 1 45%; min-width: 450px; }}
        h2 {{ color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }}
        p.intro {{ text-align: center; color: #ccf; font-size: 1.1em; margin-top: 10px; }}
    </style>
</head>
<body>
    <div class="header">
        <h1>An√°lise Comparativa de Regimes Tribut√°rios</h1>
        <p class="intro">Dados do arquivo {os.path.basename(FILE_NAME)}</p>
    </div>

    <div class="container">
        <div class="card">
            <h2>üí∞ Valor Absoluto do Imposto (R$)</h2>
            <p>O custo total em Reais para cada Regime de Tributa√ß√£o simulado. (Clique para interagir)</p>
            {fig_valor.to_html(full_html=False, include_plotlyjs='cdn')}
        </div>
        <div class="card">
            <h2>üìà Al√≠quota Efetiva (%)</h2>
            <p>A porcentagem real que a empresa paga em impostos sobre a Receita. (Clique para interagir)</p>
            {fig_aliquota.to_html(full_html=False, include_plotlyjs='cdn')}
        </div>
    </div>
</body>
</html>
"""

    # Salvar o conte√∫do em um arquivo HTML
    with open(HTML_OUTPUT, 'w', encoding='utf-8') as f:
        f.write(html_content)
        
    # Abrir o arquivo no navegador
    try:
        abs_path = os.path.abspath(HTML_OUTPUT)
        webbrowser.open('file://' + abs_path, new=2)
    except Exception:
        pass 

    print(f"\n‚úÖ Dashboard '{HTML_OUTPUT}' gerado com sucesso! (Abra o arquivo manualmente se necess√°rio)")


if __name__ == "__main__":
    generate_tax_dashboard()
